# Script: Compactage Docker WSL VHDX - R√©cup√®re de l'espace disque
# Auteur: Inspir√© de docs officielles Docker/WSL et Stack Overflow
# Date: 15 D√©cembre 2025

# √âtape 1: Nettoyer Docker (supprime images/conteneurs/volumes inutiles)
Write-Host "üöÄ √âtape 1: Nettoyage Docker..." -ForegroundColor Green
docker system prune -a --volumes -f  # -f pour forcer sans confirmation
docker builder prune -a -f
Write-Host "Nettoyage termin√©. Espace lib√©r√© : $(docker system df -v)" -ForegroundColor Yellow

# √âtape 2: Arr√™ter Docker et WSL
Write-Host "üõë √âtape 2: Arr√™t de Docker et WSL..." -ForegroundColor Yellow
# Quitte Docker Desktop via ligne de commande (alternative: ferme manuellement via tray icon)
& "C:\Program Files\Docker\Docker\DockerCli.exe" -SwitchDaemon  # Si besoin, mais souvent pas n√©cessaire
wsl --shutdown
Write-Host "WSL arr√™t√©." -ForegroundColor Green

# √âtape 3: Compactage du VHDX avec diskpart (plus s√ªr pour sparses)
Write-Host "üíæ √âtape 3: Compactage du fichier docker_data.vhdx..." -ForegroundColor Green
$vhdxPath = "C:\Users\[TonNom]\AppData\Local\Docker\wsl\disk\docker_data.vhdx"  # REMPLACE PAR TON CHEMIN EXACT !

# V√©rifier si le fichier existe
if (-not (Test-Path $vhdxPath)) {
    Write-Error "‚ùå Fichier VHDX non trouv√© ! V√©rifie le chemin: $vhdxPath"
    exit 1
}

# Lancer diskpart en mode script (automatis√©)
$diskpartScript = @"
select vdisk file="$vhdxPath"
attach vdisk readonly
compact vdisk
detach vdisk
exit
"@

# √âcrire le script temporaire et l'ex√©cuter
$tempScript = [System.IO.Path]::GetTempFileName() + ".txt"
$diskpartScript | Out-File -FilePath $tempScript -Encoding ASCII
diskpart /s $tempScript
Remove-Item $tempScript -Force

Write-Host "Compactage termin√© ! V√©rifie la taille du fichier avec Get-Item $vhdxPath" -ForegroundColor Green

# √âtape 4: Red√©marrer WSL et Docker
Write-Host "üîÑ √âtape 4: Red√©marrage..." -ForegroundColor Yellow
wsl --status  # V√©rifie que c'est OK
Start-Process "C:\Program Files\Docker\Docker\Docker Desktop.exe"  # Red√©marre Docker Desktop
Write-Host "‚úÖ Script termin√© ! V√©rifie l'espace disque lib√©r√© avec 'docker system df' ou Explorateur Windows." -ForegroundColor Green